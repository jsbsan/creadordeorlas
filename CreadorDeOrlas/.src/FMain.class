' Gambas class file

Public listaTiposDeLetra As New ClassDatoLetra[] 'lista de letras que contiene el sistema

Public GridViewRegistrosAlumnos As ClassSuperGridview
Public Observador1 As Observer

Public GridViewRegistrosProfesores As ClassSuperGridview
Public Observador2 As Observer

Public Sub Form_Open()
  
  Dim pensando As New FormPensando 
  'comprobar si ya hay una instancia del programa ejecutandose...
  If ModuleUnicaVez.ejecutandoUnicaCopia("CreadorDeOrlas.gambas") <> True Then
    pensando.Show()
    Wait 0.5
    LabelVersion.text = "Versión: Beta " & Application.Version
    Me.center
    ModuleUpdate.comprobar("CreadorDeOrlas", Application.Version, "http://creadordeorlas.blogspot.com.es/2013/03/version.html", "no mensaje")
    
    ModulePruebas.escribe()
    comun.comprobarEntorno()
    'inicio el programa: creo directorios y copio archivos...
    ModulePrincipal.iniciarDirectorios()
    
    ModulePruebas.escribe()
    Print "hola iniciandome..."
    
    'feditor.plantillaActual = User.home & "/Imágenes/Orlas/ORLAplantillasAntonio/ORLAejemplo01/orla.svg"
    Try Mkdir User.home & "/temporal.orla"
    Try Copy "Plantillas/orla1/adorno.png" To User.home & "/temporal.orla/adorno.png"
    Try Copy "Plantillas/orla1/borde.png" To User.home & "/temporal.orla/borde.png"
    Try Copy "Plantillas/orla1/cinta.svg" To User.home & "/temporal.orla/cinta.svg"
    Try Copy "Plantillas/orla1/ESCUDO01" To User.home & "/temporal.orla/ESCUDO01"
    Try Copy "Plantillas/orla1/ESCUDO02" To User.home & "/temporal.orla/ESCUDO02"
    Try Copy "Plantillas/orla1/esquina.png" To User.home & "/temporal.orla/esquina.png"
    Try Copy "Plantillas/orla1/Detalles_en_azul_y_negro_marco.svg" To User.home & "/temporal.orla/Detalles_en_azul_y_negro_marco.svg"
    
    'crear gridview y sus observadores....para  diplomas tematicos, registros alumnos
    GridViewRegistrosAlumnos = New ClassSuperGridview(IconPanel1[3])
    Observador1 = New Observer(GridViewRegistrosAlumnos) As "ObservadorGridViewRegistrosAlumnos"
    
    GridViewRegistrosProfesores = New ClassSuperGridview(IconPanel1[4])
    Observador2 = New Observer(GridViewRegistrosProfesores) As "ObservadorGridViewRegistrosProfesores"
    
    ModuleIntermedio.IniciarGridViewRegistrosAlumnos(GridViewRegistrosAlumnos)
    ModuleIntermedio.IniciarGridViewRegistrosProfesoresores(GridViewRegistrosProfesores)
    
    pensando.parar = True
    pensando.Delete()
    
  Else
    'como ya hay una instancia de esta aplicacion abierta, salgo
    Me.Close()
  Endif
  
End

Public Sub ButtonEditorOrla_Click()
  'Reemplaza la plantilla con los datos que ha introducido (colegio, curso,etc )
  
  Dim feditor As New FMainEditor
  
  FormPensando.show()
  Wait 0.5
  feditor.plantillaActual = User.home & "/temporal.orla/Detalles_en_azul_y_negro_marco.svg"
  feditor.Show()
  
End

Public Sub Label9_MouseDown()
  
  Desktop.Open("http://www.jsbsan.blogspot.com.es/")
  
End

Public Sub Label13_MouseDown()
  
  Desktop.Open("http://minino.galpon.org/es/descargas")  
  
End

Public Sub Label12_MouseDown()
  
  Desktop.Open("http://inkscape.org/")
  
End

Public Sub ToolButtonEditar3_Click()
  
  FormPlantillaOrla.Show()
  
End

Public Sub ToolButtonTipoLetraAlumno_Click()
  
  Dialog.font = LabelTipoAlumno.Font
  If Not Dialog.selectFont() Then 
    LabelTipoAlumno.text = Dialog.Font.name 
    LabelTipoAlumno.font = Dialog.Font
  Endif
  
End

Public Sub ToolButtonTipoLetraProfesor_Click()
  
  Dialog.font = LabelTipoProfesor.Font
  If Not Dialog.selectFont() Then 
    LabelTipoProfesor.text = Dialog.Font.name
    LabelTipoProfesor.font = Dialog.Font
  Endif
  
End

Public Sub ToolButtonCrear_Click()
  
  Dim respuesta As Integer
  
  If TextBoxNombreFicheroNuevo.Text = "" Then
    Message.Error("Necesita poner un nombre")
  Else
    'comprobar que si existe...
    If Not Exist(DirChooserElegirDirectorioCrearGrupo.Value & "/" & TextBoxNombreFicheroNuevo.text & ".Orla") Then
      
    Else
      respuesta = Message.Question("Existe el fichero:" & gb.CrLf & DirChooserElegirDirectorioCrearGrupo.Value & "/" & TextBoxNombreFicheroNuevo.text & gb.crlf & "¿que desea hacer?", " SobreEscribir ", " Cancelar ")
      If respuesta = 1 Then 
        
      Else
        'ha cancelado la operacion...
        Print "Cancelado Crear Grupo"
        
      Endif
      
    Endif
    
  Endif
  
End

Public Sub IconPanel1_Click()
  
  If IconPanel1.Index = 9 Then Me.Close
  
End

Public Sub Label19_MouseDown()
  
End

Public Sub botontransparente_Click()
  
  Dim numero As Integer
  
  numero = Val(Last.tag)
  
  Select numero
    Case 1
      '   reg.ImagenFondo = ModuleHacerTransparente.convertirTransparente(ModulePrincipal.RutaPrograma & "temporales/FotosPlantillasTematica/" & reg.ImagenFondo)
      '   PictureBoxFondo.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.ImagenFondo]
      '   PictureBoxFondo.tag = reg.ImagenFondo 
    Case 2
      '   reg.ImagenMarco = ModuleHacerTransparente.convertirTransparente(ModulePrincipal.RutaPrograma & "temporales/FotosPlantillasTematica/" & reg.ImagenMarco)
      '   PictureBoxMarco.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.ImagenMarco]
      '   PictureBoxMarco.tag = reg.ImagenMarco
    Case 3
      '   reg.ImagenLogo = ModuleHacerTransparente.convertirTransparente(ModulePrincipal.RutaPrograma & "temporales/FotosPlantillasTematica/" & reg.ImagenLogo)
      '   PictureBoxLogo.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.ImagenLogo]
      '   PictureBoxlogo.tag = reg.ImagenLogo
    Case 4
      '   reg.Foto04 = ModuleHacerTransparente.convertirTransparente(ModulePrincipal.RutaPrograma & "temporales/FotosPlantillasTematica/" & reg.Foto04)
      '   PictureBoxFoto04.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.Foto04]
      '   PictureBoxfoto04.tag = reg.Foto04
    Case 5
      '   reg.Foto05 = ModuleHacerTransparente.convertirTransparente(ModulePrincipal.RutaPrograma & "temporales/FotosPlantillasTematica/" & reg.Foto05)
      '   PictureBoxFoto05.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.Foto05]
      '  PictureBoxfoto05.tag = reg.Foto05
  End Select
  
End

Public Sub PictureBoxFondo_MouseDown()
  
  PictureBoxFondo.tag = asignaImagen(PictureBoxFondo)
  
End

Public Sub PictureBoxEscudo_MouseDown()
  
  PictureBoxEscudo.Tag = asignaImagen(PictureBoxEscudo)
  
End

Public Sub PictureBoxLogo_MouseDown()
  
  PictureBoxLogo.Tag = asignaImagen(PictureBoxLogo)
  
End

Public Sub PictureBoxLogo2_MouseDown()
  
  PictureBoxLogo2.Tag = asignaImagen(PictureBoxLogo2)
  
End

'------------------------------- Asignar Imagen ---------------------
Private Sub asignaImagen(PictureBoxElegido As Picturebox) As String
  
  Dim dialogofile As New FormElegirFichero
  Dim dat As New ClassDato
  
  dialogofile.valor = dat
  
  dialogofile.Titulo = ("Elija el archivo gráfico")
  dialogofile.Filtro = ["*.png;*.jpg;*.jpeg;*.bmp", ("Ficheros de Imágenes")]
  dialogofile.ShowModal()
  
  If dat.dato = "-1" Then Return
  
  Return asignaImagen2Paso(dat.dato, PictureBoxElegido)
  
End

Private Function asignaImagen2Paso(ruta As String, PictureBoxElegido As Picturebox) As String
  
  Dim nombrecopia As String
  Dim extension As String
  Dim comparacion As String 'añadido para comprobar si existe un fichero con el mismo nombre y es igual
  Dim copiar As String
  Dim comando As String
  Dim nombresimple As String
  
  If Not Exist(ruta) Then
    Message.Info(("No se ha podido descargarse el archivo")) 
    Return 
  Endif
  
  PictureBoxElegido.Picture = Picture["importar.png"]
  Wait 0.1
  PictureBoxElegido.Picture = Picture[ruta]
  PictureBoxElegido.tag = ruta
  copiar = "si"
  
  nombresimple = ModuleUtilidadesDisco.VerificarNombreEtiqueta(Replace(ModuleUtilidadesDisco.extraedesdebarra(PictureBoxElegido.tag), " ", "_"), ["FOTO", "PLANTILLA", "CAMPO"], ["Imagen", "PLA_TILLA", "CA_PO"])
  ''TODO: MODIFICAR RUTA...
  nombrecopia = ModulePrincipal.RutaPrograma & "temporales/FotosPlantillasTematica/" & nombresimple
  
  While (Exist(nombrecopia))
    'si existe fichero con el mismo nombre, 1º comprobar si es igual...
    comando = "cmp " & nombrecopia & " " & PictureBoxElegido.tag
    Shell comando To comparacion
    If comparacion = "" Then 
      'son iguales-> no hace falta cambiar de nombre ya que lo tengo...
      'no hago la copia
      copiar = "no"
      
      Break
    Endif
    
    'para que no machaque nombres de fichros...
    extension = ModuleUtilidadesDisco.extraeExtension(nombrecopia)
    If extension <> "" Then 
      nombrecopia = Mid$(nombrecopia, 1, Len(nombrecopia) - Len(extension) - 1) & "c" & "." & extension
      copiar = "si"
    Else
      nombrecopia = Mid$(nombrecopia, 1, Len(nombrecopia) - Len(extension)) & "c" 
      copiar = "si"
    Endif
    
  Wend
  
  If copiar = "si" Then 
    
    Exec ["cp", PictureBoxElegido.tag, nombrecopia] Wait
    PictureBoxElegido.Picture = Picture["importar.png"]
    Wait 0.1
    PictureBoxElegido.Picture = Picture[nombrecopia]
    PictureBoxElegido.tag = nombrecopia
    
  Endif
  
  Return ModuleUtilidadesDisco.extraedesdebarra(nombrecopia)
  
End
